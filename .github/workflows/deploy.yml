name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (just restart)'
        required: false
        default: 'false'
        type: boolean

env:
  DEPLOY_PATH: /var/www/wrocdevs.com

jobs:
  deploy:
    name: Deploy to Digital Ocean
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          command_timeout: 30m
          script_stop: true
          script: |
            set -e

            echo "=== Deployment started ==="
            cd ${{ env.DEPLOY_PATH }}

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Loading environment ==="
            source .env

            echo "=== Building and starting containers ==="
            echo "Building Docker image with Payload CMS support..."
            sudo DOCKER_BUILDKIT=1 docker build --network=host --build-arg DATABASE_URI="postgresql://postgres:${DB_PASSWORD}@127.0.0.1:5433/payload" --build-arg PAYLOAD_SECRET="${PAYLOAD_SECRET}" -t wrocdevs-app:latest .

            echo "Restarting app container..."
            sudo docker compose -f docker-compose.prod.yml up -d --force-recreate app

            echo "=== Waiting for app to be healthy ==="
            sleep 10

            echo "=== Cleaning up old images ==="
            sudo docker image prune -f

            echo "=== Deployment completed ==="
            sudo docker compose -f docker-compose.prod.yml ps

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            echo "=== Checking application health ==="
            for i in {1..12}; do
              if curl -sf http://localhost:3001 > /dev/null 2>&1; then
                echo "Application is healthy!"
                exit 0
              fi
              echo "Waiting for application to start... (attempt $i/12)"
              sleep 5
            done
            echo "Health check failed!"
            sudo docker compose -f /var/www/wrocdevs.com/docker-compose.prod.yml logs --tail=50 app
            exit 1

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Deployment Failed
        run: |
          echo "Deployment to production failed!"
          echo "Check the workflow logs for details."
