name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
      - name: Deploy and Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: true
          script: |
            set -e
            cd /var/www/wrocdevs.com

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main

            echo "=== Building Docker image ==="
            source .env
            DOCKER_BUILDKIT=1 docker build --network=host --build-arg DATABASE_URI="postgresql://postgres:${DB_PASSWORD}@127.0.0.1:5433/payload" --build-arg PAYLOAD_SECRET="${PAYLOAD_SECRET}" -t wrocdevs-app:latest .

            echo "=== Restarting app container ==="
            docker compose -f docker-compose.prod.yml up -d --force-recreate app

            echo "=== Health check ==="
            for i in {1..12}; do
              if curl -sf http://127.0.0.1:3001 > /dev/null 2>&1; then
                echo "Application is healthy!"
                docker image prune -f
                docker compose -f docker-compose.prod.yml ps
                exit 0
              fi
              echo "Waiting... ($i/12)"
              sleep 5
            done

            echo "Health check failed!"
            docker compose -f docker-compose.prod.yml logs --tail=50 app
            exit 1
